// jshint esversion:8
const week18 = [{
    "_id": "c5971ee9-b37c-11eb-acb9-bc5b029089d3",
    "time": "2022-01-08T13:30:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sat 1:30pm PST",
    "home": {
      "id": 10,
      "score": 0
    },
    "away": {
      "id": 16,
      "score": 0
    }
  },{
    "_id": "c59797ef-b37c-11eb-a318-b1d0e7e8792e",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 4,
      "score": 0
    },
    "away": {
      "id": 25,
      "score": 0
    }
  },{
    "_id": "c596edd8-b37c-11eb-a2e3-1893925df770",
    "time": "2022-01-08T17:15:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sat 5:15pm PST",
    "home": {
      "id": 26,
      "score": 0
    },
    "away": {
      "id": 9,
      "score": 0
    }
  },{
    "_id": "c59757a5-b37c-11eb-901f-b386dd79c602",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 13,
      "score": 0
    },
    "away": {
      "id": 31,
      "score": 0
    }
  },{
    "_id": "c59755e6-b37c-11eb-9e19-00bc1829d24f",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 2,
      "score": 0
    },
    "away": {
      "id": 23,
      "score": 0
    }
  },{
    "_id": "c59762b8-b37c-11eb-a78a-30c5c677cad5",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 3,
      "score": 0
    },
    "away": {
      "id": 27,
      "score": 0
    }
  },{
    "_id": "c5972dc4-b37c-11eb-a4de-4a9ece5dcb0d",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 30,
      "score": 0
    },
    "away": {
      "id": 5,
      "score": 0
    }
  },{
    "_id": "c59704f5-b37c-11eb-a168-a6c97a9e291b",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 24,
      "score": 0
    },
    "away": {
      "id": 32,
      "score": 0
    }
  },{
    "_id": "c597276d-b37c-11eb-a824-966776c37c34",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 21,
      "score": 0
    },
    "away": {
      "id": 6,
      "score": 0
    }
  },{
    "_id": "c597373f-b37c-11eb-a4b9-33ea453005d5",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 20,
      "score": 0
    },
    "away": {
      "id": 22,
      "score": 0
    }
  },{
    "_id": "c596f86e-b37c-11eb-acef-004a6dd04236",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 11,
      "score": 0
    },
    "away": {
      "id": 12,
      "score": 0
    }
  },{
    "_id": "c597c0fd-b37c-11eb-9064-a3b8d28903d4",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 8,
      "score": 0
    },
    "away": {
      "id": 7,
      "score": 0
    }
  },{
    "_id": "c5972e26-b37c-11eb-a3ba-55ec1a6e189e",
    "time": "2022-01-09T13:25:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 1:25pm PST",
    "home": {
      "id": 1,
      "score": 0
    },
    "away": {
      "id": 28,
      "score": 0
    }
  },{
    "_id": "c596ff9e-b37c-11eb-a238-2558151bb271",
    "time": "2022-01-09T13:25:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 1:25pm PST",
    "home": {
      "id": 17,
      "score": 0
    },
    "away": {
      "id": 29,
      "score": 0
    }
  },{
    "_id": "c5970285-b37c-11eb-b268-91616e0aa8ce",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 15,
      "score": 0
    },
    "away": {
      "id": 14,
      "score": 0
    }
  },{
    "_id": "c596f997-b37c-11eb-9f27-33818e4d796d",
    "time": "2022-01-09T17:20:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 5:20pm PST",
    "home": {
      "id": 19,
      "score": 0
    },
    "away": {
      "id": 18,
      "score": 0
    }
  }];

  let players = [
    "Josh Allen",
    "Jonathan Taylor",
    "Patrick Mahomes",
    "Christian McCaffrey",
    "Justin Herbert",
    "Lamar Jackson",
    "Derrick Henry",
    "Jalen Hurts",
    "Tom Brady",
    "Austin Ekeler",
    "Joe Mixon",
    "Kyler Murray",
    "Dalvin Cook",
    "Aaron Rodgers",
    "Cooper Kupp",
    "Dak Prescott",
    "Najee Harris",
    "Nick Chubb",
    "Aaron Jones",
    "Alvin Kamara",
    "Joe Burrow",
    "Javonte Williams",
    "Russell Wilson",
    "Leonard Fournette",
    "Matthew Stafford",
    "Kirk Cousins",
    "Derek Carr",
    "Justin Jefferson",
    "Trey Lance",
    "Trevor Lawrence",
    "Matt Ryan",
    "Justin Fields",
    "Deebo Samuel",
    "Ja'Marr Chase",
    "James Conner",
    "Tua Tagovailoa",
    "Saquon Barkley",
    "Davante Adams",
    "Stefon Diggs",
    "D'Andre Swift",
    "Jameis Winston",
    "Daniel Jones",
    "Breece Hall",
    "Tyreek Hill",
    "Cam Akers",
    "Ezekiel Elliott",
    "David Montgomery",
    "Josh Jacobs",
    "Keenan Allen",
    "Ryan Tannehill",
    "Mark Andrews",
    "Travis Kelce",
    "Elijah Mitchell",
    "Mac Jones",
    "J.K. Dobbins",
    "Travis Etienne",
    "Mike Evans",
    "Antonio Gibson",
    "Baker Mayfield",
    "CeeDee Lamb",
    "Damien Harris",
    "Clyde Edwards-Helaire",
    "AJ Dillon",
    "Rashaad Penny",
    "Dameon Pierce",
    "Carson Wentz",
    "Miles Sanders",
    "Chase Edmonds",
    "Devin Singletary",
    "Rhamondre Stevenson",
    "Kareem Hunt",
    "Jared Goff",
    "Tony Pollard",
    "Mike Williams",
    "Tee Higgins",
    "Gabe Davis",
    "Davis Mills",
    "Michael Pittman",
    "Cordarrelle Patterson",
    "A.J. Brown",
    "James Robinson",
    "Mitchell Trubisky",
    "Terry McLaurin",
    "Zach Wilson",
    "Courtland Sutton",
    "Nyheim Hines",
    "Melvin Gordon",
    "Marcus Mariota",
    "Raheem Mostert",
    "D.J. Moore",
    "Jerry Jeudy",
    "Marquise Brown",
    "Geno Smith",
    "Kyle Pitts",
    "Diontae Johnson",
    "DK Metcalf",
    "Brandin Cooks",
    "Allen Robinson",
    "Jaylen Waddle",
    "Darnell Mooney",
    "Michael Carter",
    "Tyler Allgeier",
    "Chris Godwin",
    "Adam Thielen",
    "James Cook",
    "George Kittle",
    "JuJu Smith-Schuster",
    "Rashod Bateman",
    "Kenneth Walker III",
    "Amari Cooper",
    "Jacoby Brissett",
    "Amon-Ra St. Brown",
    "Elijah Moore",
    "Allen Lazard",
    "DeVonta Smith",
    "Michael Thomas",
    "Hunter Renfrow",
    "Kenneth Gainwell",
    "Darren Waller",
    "Brandon Aiyuk",
    "Jamaal Williams",
    "Darrell Henderson",
    "DeAndre Hopkins",
    "Jerick McKinnon",
    "Dalton Schultz",
    "Isiah Pacheco",
    "Christian Kirk",
    "Rex Burkhead",
    "Dallas Goedert",
    "Justin Tucker",
    "Tyler Lockett",
    "Alexander Mattison",
    "Drake London",
    "Kenny Pickett",
    "Buffalo Bills",
    "Mark Ingram",
    "Robert Woods",
    "Marquez Valdes-Scantling",
    "Chris Olave",
    "Kadarius Toney",
    "J.D. McKissic",
    "Rachaad White",
    "Zamir White",
    "Khalil Herbert",
    "Chase Claypool",
    "Brian Robinson",
    "Deshaun Watson",
    "Jimmy Garoppolo",
    "Darrel Williams",
    "Skyy Moore",
    "Damien Williams",
    "Nico Collins",
    "Eno Benjamin",
    "Evan McPherson",
    "D.J. Chark",
    "Treylon Burks",
    "Dawson Knox",
    "Boston Scott",
    "Tampa Bay Buccaneers",
    "Matt Gay",
    "Alec Pierce",
    "Michael Gallup",
    "Harrison Butker",
    "Green Bay Packers",
    "San Francisco 49ers",
    "Garrett Wilson",
    "Daniel Carlson",
    "Nick Folk",
    "New Orleans Saints",
    "Indianapolis Colts",
    "Tyler Bass",
    "Dustin Hopkins",
    "Jahan Dotson",
    "Dallas Cowboys",
    "Baltimore Ravens",
    "Brandon McManus",
    "Romeo Doubs",
    "Isaiah Spiller",
    "Miami Dolphins",
    "Los Angeles Chargers",
    "Ryan Succop",
    "Los Angeles Rams",
    "Tyler Boyd",
    "Pittsburgh Steelers",
    "New England Patriots",
    "Matt Prater",
    "George Pickens",
    "Greg Joseph",
    "Drew Lock",
    "Washington Commanders",
    "Bryan Edwards",
    "Cleveland Browns",
    "Hunter Henry",
    "Robbie Gould",
    "Cincinnati Bengals",
    "Philadelphia Eagles",
    "Denver Broncos",
    "Wil Lutz",
    "Graham Gano",
    "Jake Elliott",
    "Tennessee Titans",
    "Desmond Ridder",
    "Chris Boswell",
    "Kansas City Chiefs",
    "Younghoe Koo",
    "Rodrigo Blankenship",
    "T.J. Hockenson",
    "Jason Sanders",
    "Minnesota Vikings",
    "Carolina Panthers",
    "Seattle Seahawks",
    "Randy Bullock",
    "Cairo Santos",
    "Mason Crosby",
    "Chicago Bears",
    "Austin Seibert"
  ]

const mongo = require('./cflmongo');
const axios = require('axios');
const fs = require('fs-extra');
const _ = require('lodash');
const url = "https://api.fantasy.nfl.com/v3/players?includeLegacyIds=true&appKey=12345";
const nflurl = "https://api.fantasy.nfl.com/v2/players/weekstats?season=2022&week=";
// const d = JSON.parse(fs.readFileSync(`${__dirname}/draft-results.json`));
const { currentWeek } = require('./general');
const { emit } = require('./socket');
const { commands, schedule$ } = require('./rxjs');

let nflschedule = [];
let teamCodes = {};

function getTeamCodes() {
  return;
  mongo.find("nflteams").then(x => {
    _.each(x, tm => {
      teamCodes[tm.nflTeamId] = tm._id;
    })
    console.log('Team Codes done');
    nfl();
  });
}

function nfl(week = 1) {
  if (week >= 19) {
    // mongo.inesertMany('nflschedule', nflschedule);
    const query = { year: 2022 };
    const set = { nflschedule };
    mongo.update('settings', { query, set });
    console.log('All Done!');
    return;    
  }
  let byes = Array.from({length: 32}, (_, i) => i + 1);
  axios.get(`${nflurl}${week}`)
    .then(res => {
      console.log('Week ' + week);
      let games = [];
      _.each(res.data.nflGames, gm => {
        const home = {
          id: teamCodes[gm.homeTeam.nflTeamId],
          score: 0
        }
        const away = {
          id: teamCodes[gm.awayTeam.nflTeamId],
          score: 0
        }
        let obj = {
          _id: gm.nflGameId,
          time: gm.gameDateAndTime,
          status: gm.gameStatus,
          quarter: gm.gameQuarter,
          clock: gm.gameClock,
          home,
          away
        }
        byes = _.difference(byes, [home.id, away.id]);
        games.push(obj);
      });
      nflschedule.push({ week, games, byes });
      nfl(++week);
    });
}

function loadTeams() {
    // axios.get(url)
    //     .then(res => {
    //         const teams = _.chain(res.data.included)
    //                         .sortBy(x => x.attributes.abbr)
    //                         .map((x, index) => {
    //                             const d = x.attributes;
    //                             return {
    //                                     _id: index + 1,
    //                                     lgId: x.id,
    //                                     abbr: d.abbr,
    //                                     byeWeek: d.byeWeek,
    //                                     city: d.city,
    //                                     fullName: d.fullName,
    //                                     nickName: d.nickName,
    //                                     image: d.imageUrl,
    //                                 }   
    //                             })
    //                         .value();
    //         //mongo.inesertMany('nflteams', teams);
    //         console.clear();
    //         console.log('ALL DONE');
    //     });
    mongo.find('nflteams')
        .then(res => {
            console.clear();
            console.log('teams', res);
        })
}

function AddPlayerToTeam(_id, cflteam) {
    const query = { _id };
    const set = {
      'weeks.0.cflteam': cflteam
    }
    mongo.update('players', { query, set });
}

async function loadDraft(n = 0, draft = []) {
  return;
  if (n >= players.length) {
    console.log('All IDS', draft);
    const query = { _id: "5d8153fdeb96554ed07993ae"};
    const set = { draft };
    mongo.update('settings', { query, set });
    return;
  }
  const round = Math.floor(n/12) + 1;
  const pick = (n % 12) + 1;
  const team = (round % 2 === 0) ? 13 - pick : pick;
  const fullname = players[n++];
  const query = { fullname };
  mongo.find('players', { query })
    .then(x => {
      console.log(`${n}. ${fullname} (${x[0]._id}) -- ROUND ${round}, PICK ${pick}, CFL TEAM: ${team}`);
      draft.push(x[0]._id);
      AddPlayerToTeam(x[0]._id, team);
      loadDraft(n, draft);
    })
  // _.each(players, async (fullname, index) => {
  //   const query = { fullname };
  //   const db = await mongo.find('players', { query });
  //   if (!db.length) {
  //     console.log(`Pick ${index+1} (${fullname}) is not in the database`);
  //   } else {
  //     if (db.length > 1) {
  //       console.log(`Pick ${index+1} (${fullname}) has more than one entry in the database`);
  //     } else {
  //       console.log(`Pick ${index + 1} (${fullname}) is id number ${db._id}`);
  //     }
  //   }
  // })
}

async function updatePlayers() {
    console.log('updating players');
    const teams = await mongo.find('nflteams');
    const length = await currentWeek();
    const allWeeks = Array.from({length}, (_, i) => i + 1);
    axios.get(url)
        .then(res => {
            const positions = ["DEF", "RB", "WR", "K", "TE", "QB"];
            const players = _.chain(res.data.data)
                              .filter(x => _.includes(positions, x.attributes.position))
                              .value();

            _.each(players, async player => {
                const data = player.attributes;
                const _id = data.legacyIds.fantasyPlayerId;
                const t = _.find(teams, t => t.lgId === (player.relationships.nflTeam.data && player.relationships.nflTeam.data.id));
                const currTeam = t && t._id || 0;
                const query = { _id };
                const db = await mongo.find('players', { query });
                if (!db.length) {
                    console.log(`${data.name} is not in the database`);
                    const position = data.position === "TE" ? "WR" : data.position;
                    const weeks = _.map(allWeeks, num => {
                        return {
                        num,
                        cflteam: 0,
                        nflteam: 0,
                        score: 0,
                        stats: {}
                        }
                    });
                    (_.last(weeks)).nflteam = currTeam;
                    const info = {
                        _id,
                        score: 0,
                        firstname: data.firstName,
                        lastname: data.lastName,
                        fullname: data.nickName,
                        number: data.jerseyNumber,
                        position,
                        pic: data.imageUrl,
                        lgId: player.id,
                        weeks,
                        stats: {}
                    }
                    await mongo.insertOne('players', info);
                } else {
                    const dbTeam = (_.last(db[0].weeks)).nflteam;
                    if (dbTeam !== currTeam || db[0].pic !== data.imageUrl) {
                        const set = {};
                        if (dbTeam !== currTeam) {
                            set[`weeks.${length-1}.nflteam`] = currTeam;
                            console.log(`${data.name} is on a new team! ${dbTeam} ==> ${currTeam}`);
                        }
                        if (db[0].pic !== data.imageUrl) {
                            set.pic = data.imageUrl;
                            console.log(`${data.name} has a new picture!`);
                        }
                        await mongo.update('players', { query, set });
                    }

                }
            });
            console.log('update players done!!!');
            emit('refresh-players');
        })
}

function init() {
    //_.each(['statCodes', 'settings'], x => mongo.inesertMany(x, JSON.parse(fs.readFileSync(`${__dirname}/collections/${x}.json`))));
    const data = JSON.parse(fs.readFileSync(`${__dirname}/collections/cflschedule.json`));
    const cflschedule = _.chain(data)
                .filter(x => x.week < 15)
                .map(x => {
                        return {
                            _id: x._id,
                            team1: {
                                id: x.team1,
                                score: 0,
                                tiebreaker: 0
                            },
                            team2: {
                                id: x.team2,
                                score: 0,
                                tiebreaker: 0
                            },
                            week: x.week,
                            winner: null
                        }
                    })
                .value();
    //mongo.inesertMany('cflschedule', cflschedule);
    console.log('cflschedule', cflschedule);
                
}

async function dodraft() {
    let players = await mongo.find('players');
    let draft = [];
    _.each(d, (pick, index) => {
        let player = _.find(players, x => x.fullname === pick);
        const _id = player._id;
        // const round = Math.floor(index / 12) + 1;
        // let team = (index % 12) + 1;
        // if (!(round % 2)) team = 13 - team;
        // console.log(`Rnd ${round}`, `team ${team}`, _id, pick);
        // const data = {};
        // data.query = { _id };
        // data.set = { 'weeks.0.cflteam': team };
        // mongo.update('players', data);
        draft.push(_id);
    })
    mongo.update('settings', { query: { _id: '5d8153fdeb96554ed07993ae'}, set: { draft }});
    console.log('all done');
}

// async function nflschedule(n = 19) {
//     console.log('running nfl schedule');
//     if (n > 18) {
//         // console.log('all done', s);
//         const query = { year: 2021 };
//         const set = { 'nflschedule.17.games': week18 };
//         mongo.update('settings', { query, set });
//         return;
//     }
//     const nfl = await mongo.find('nflteams');
//     axios.get(nflurl + n)
//         .then(res => {
//             const schedule = res.data.nflGames;
//             const week = { week: n };
//             week.games = _.map(schedule, x => {
//                 const game = {};
//                 game._id = x.nflGameId;
//                 game.week = n;
//                 game.time = x.gameDateAndTime;
//                 game.status = x.gameStatus;
//                 game.quarter = x.gameQuarter;
//                 game.clock = x.gameClock;
//                 game.home = {
//                     id: (_.find(nfl, t => t.nflTeamId === x.homeTeam.nflTeamId))._id,
//                     score: x.homeTeam.score
//                 }
//                 game.away = {
//                     id: (_.find(nfl, t => t.nflTeamId === x.awayTeam.nflTeamId))._id,
//                     score: x.awayTeam.score
//                 }
//                 mongo.insertOne('nflschedule', game);
//                 return game;
//             });
//             week.byes = _.chain(nfl)
//                             .filter(x => x.byeWeek === n)
//                             .map(x => x._id)
//                             .value();
//             // s.push(week);
//             nflschedule(++n);
//         });
// }

function getOwners() {
  mongo.find('cflschedule')
    .then(x => {
      // _.sortBy(x, t => t.draftOrder);
      let s = _.sortBy(x, t => t.week);
      s = _.filter(s, m => m.week <= 15);
      s = _.map(s, m => {
        m.winner = null;
        m.team1.score = 0;
        delete m.team1.tiebreaker;
        m.team2.score = 0;
        delete m.team2.tiebreaker;
        return m;
      })
      fs.writeJSON('cflschedule.json', s);
      console.log('All Done!!!!');
    })
}

async function saveWeek(week) {
  const query = { year: 2022 };
  const addToSet = {};
  addToSet['weeks'] = week;
  await mongo.addToArray('settings', { query, addToSet });
  console.log(`Week ${week.num} updated!`);
}

async function saveMoves(moves, week) {
  const query = { year: 2022 };
  const push = {};
  push[`weeks.${week-1}.activations`] = moves;
  await mongo.pushToArray('settings', { query, push });
  console.log('all done. see if it worked', query, push);
}


let n = 0;
let s = "second";

async function checkForUpdates() {
  console.log(`${++n} ${s}`);
  s = "seconds";
  if (mongo.connected()) {
    // let i = 3;
    // while (i <= 17) {
    //   let obj = {
    //     num: i++,
    //     started: false,
    //     moves: [],
    //     activations: [],
    //     waivers: [[]]
    //   }
    //   await saveWeek(obj);
    // }
    // console.log('All Done!');
    saveMoves([0,1,2,3,4,5], 2);
  } else {
    setTimeout(checkForUpdates, 1000);
  }
} 

//setTimeout(checkForUpdates, 1000);

// setTimeout(nflschedule, 4000);
// nflschedule();

schedule$
    .subscribe(data => {
        if (data === commands.UPDATEPLAYERS) updatePlayers();
    })