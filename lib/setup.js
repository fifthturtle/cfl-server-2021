// jshint esversion:8
const week18 = [{
    "_id": "c5971ee9-b37c-11eb-acb9-bc5b029089d3",
    "time": "2022-01-08T13:30:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sat 1:30pm PST",
    "home": {
      "id": 10,
      "score": 0
    },
    "away": {
      "id": 16,
      "score": 0
    }
  },{
    "_id": "c59797ef-b37c-11eb-a318-b1d0e7e8792e",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 4,
      "score": 0
    },
    "away": {
      "id": 25,
      "score": 0
    }
  },{
    "_id": "c596edd8-b37c-11eb-a2e3-1893925df770",
    "time": "2022-01-08T17:15:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sat 5:15pm PST",
    "home": {
      "id": 26,
      "score": 0
    },
    "away": {
      "id": 9,
      "score": 0
    }
  },{
    "_id": "c59757a5-b37c-11eb-901f-b386dd79c602",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 13,
      "score": 0
    },
    "away": {
      "id": 31,
      "score": 0
    }
  },{
    "_id": "c59755e6-b37c-11eb-9e19-00bc1829d24f",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 2,
      "score": 0
    },
    "away": {
      "id": 23,
      "score": 0
    }
  },{
    "_id": "c59762b8-b37c-11eb-a78a-30c5c677cad5",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 3,
      "score": 0
    },
    "away": {
      "id": 27,
      "score": 0
    }
  },{
    "_id": "c5972dc4-b37c-11eb-a4de-4a9ece5dcb0d",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 30,
      "score": 0
    },
    "away": {
      "id": 5,
      "score": 0
    }
  },{
    "_id": "c59704f5-b37c-11eb-a168-a6c97a9e291b",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 24,
      "score": 0
    },
    "away": {
      "id": 32,
      "score": 0
    }
  },{
    "_id": "c597276d-b37c-11eb-a824-966776c37c34",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 21,
      "score": 0
    },
    "away": {
      "id": 6,
      "score": 0
    }
  },{
    "_id": "c597373f-b37c-11eb-a4b9-33ea453005d5",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 20,
      "score": 0
    },
    "away": {
      "id": 22,
      "score": 0
    }
  },{
    "_id": "c596f86e-b37c-11eb-acef-004a6dd04236",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 11,
      "score": 0
    },
    "away": {
      "id": 12,
      "score": 0
    }
  },{
    "_id": "c597c0fd-b37c-11eb-9064-a3b8d28903d4",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 8,
      "score": 0
    },
    "away": {
      "id": 7,
      "score": 0
    }
  },{
    "_id": "c5972e26-b37c-11eb-a3ba-55ec1a6e189e",
    "time": "2022-01-09T13:25:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 1:25pm PST",
    "home": {
      "id": 1,
      "score": 0
    },
    "away": {
      "id": 28,
      "score": 0
    }
  },{
    "_id": "c596ff9e-b37c-11eb-a238-2558151bb271",
    "time": "2022-01-09T13:25:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 1:25pm PST",
    "home": {
      "id": 17,
      "score": 0
    },
    "away": {
      "id": 29,
      "score": 0
    }
  },{
    "_id": "c5970285-b37c-11eb-b268-91616e0aa8ce",
    "time": "2022-01-09T10:00:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 10:00am PST",
    "home": {
      "id": 15,
      "score": 0
    },
    "away": {
      "id": 14,
      "score": 0
    }
  },{
    "_id": "c596f997-b37c-11eb-9f27-33818e4d796d",
    "time": "2022-01-09T17:20:00-08:00",
    "status": "pre_game",
    "quarter": null,
    "clock": "Sun 5:20pm PST",
    "home": {
      "id": 19,
      "score": 0
    },
    "away": {
      "id": 18,
      "score": 0
    }
  }];

const mongo = require('./cflmongo');
const axios = require('axios');
const fs = require('fs-extra');
const _ = require('lodash');
const url = "https://api.fantasy.nfl.com/v3/players?includeLegacyIds=true&appKey=12345";
const nflurl = "https://api.fantasy.nfl.com/v2/players/weekstats?season=2021&week=";
// const d = JSON.parse(fs.readFileSync(`${__dirname}/draft-results.json`));
const { currentWeek } = require('./general');
const { emit } = require('./socket');
const { commands, schedule$ } = require('./rxjs');

function loadTeams() {
    // axios.get(url)
    //     .then(res => {
    //         const teams = _.chain(res.data.included)
    //                         .sortBy(x => x.attributes.abbr)
    //                         .map((x, index) => {
    //                             const d = x.attributes;
    //                             return {
    //                                     _id: index + 1,
    //                                     lgId: x.id,
    //                                     abbr: d.abbr,
    //                                     byeWeek: d.byeWeek,
    //                                     city: d.city,
    //                                     fullName: d.fullName,
    //                                     nickName: d.nickName,
    //                                     image: d.imageUrl,
    //                                 }   
    //                             })
    //                         .value();
    //         //mongo.inesertMany('nflteams', teams);
    //         console.clear();
    //         console.log('ALL DONE');
    //     });
    mongo.find('nflteams')
        .then(res => {
            console.clear();
            console.log('teams', res);
        })
}

async function updatePlayers() {
    console.log('updating players');
    const teams = await mongo.find('nflteams');
    const length = await currentWeek();
    const allWeeks = Array.from({length}, (_, i) => i + 1);
    axios.get(url)
        .then(res => {
            const positions = ["DEF", "RB", "WR", "K", "TE", "QB"];
            const players = _.chain(res.data.data)
                              .filter(x => _.includes(positions, x.attributes.position))
                              .value();

            _.each(players, async player => {
                const data = player.attributes;
                const _id = data.legacyIds.fantasyPlayerId;
                const t = _.find(teams, t => t.lgId === (player.relationships.nflTeam.data && player.relationships.nflTeam.data.id));
                const currTeam = t && t._id || 0;
                const query = { _id };
                const db = await mongo.find('players', { query });
                if (!db.length) {
                    console.log(`${data.name} is not in the database`);
                    const position = data.position === "TE" ? "WR" : data.position;
                    const weeks = _.map(allWeeks, num => {
                        return {
                        num,
                        cflteam: 0,
                        nflteam: 0,
                        score: 0,
                        stats: {}
                        }
                    });
                    (_.last(weeks)).nflteam = currTeam;
                    const info = {
                        _id,
                        score: 0,
                        firstname: data.firstName,
                        lastname: data.lastName,
                        fullname: data.nickName,
                        number: data.jerseyNumber,
                        position,
                        pic: data.imageUrl,
                        lgId: player.id,
                        weeks,
                        stats: {}
                    }
                    await mongo.insertOne('players', info);
                } else {
                    const dbTeam = (_.last(db[0].weeks)).nflteam;
                    if (dbTeam !== currTeam || db[0].pic !== data.imageUrl) {
                        const set = {};
                        if (dbTeam !== currTeam) {
                            set[`weeks.${length-1}.nflteam`] = currTeam;
                            console.log(`${data.name} is on a new team! ${dbTeam} ==> ${currTeam}`);
                        }
                        if (db[0].pic !== data.imageUrl) {
                            set.pic = data.imageUrl;
                            console.log(`${data.name} has a new picture!`);
                        }
                        await mongo.update('players', { query, set });
                    }

                }
            });
            console.log('update players done!!!');
            emit('refresh-players');
        })
}

function init() {
    //_.each(['statCodes', 'settings'], x => mongo.inesertMany(x, JSON.parse(fs.readFileSync(`${__dirname}/collections/${x}.json`))));
    const data = JSON.parse(fs.readFileSync(`${__dirname}/collections/cflschedule.json`));
    const cflschedule = _.chain(data)
                .filter(x => x.week < 15)
                .map(x => {
                        return {
                            _id: x._id,
                            team1: {
                                id: x.team1,
                                score: 0,
                                tiebreaker: 0
                            },
                            team2: {
                                id: x.team2,
                                score: 0,
                                tiebreaker: 0
                            },
                            week: x.week,
                            winner: null
                        }
                    })
                .value();
    //mongo.inesertMany('cflschedule', cflschedule);
    console.log('cflschedule', cflschedule);
                
}

async function dodraft() {
    let players = await mongo.find('players');
    let draft = [];
    _.each(d, (pick, index) => {
        let player = _.find(players, x => x.fullname === pick);
        const _id = player._id;
        // const round = Math.floor(index / 12) + 1;
        // let team = (index % 12) + 1;
        // if (!(round % 2)) team = 13 - team;
        // console.log(`Rnd ${round}`, `team ${team}`, _id, pick);
        // const data = {};
        // data.query = { _id };
        // data.set = { 'weeks.0.cflteam': team };
        // mongo.update('players', data);
        draft.push(_id);
    })
    mongo.update('settings', { query: { _id: '5d8153fdeb96554ed07993ae'}, set: { draft }});
    console.log('all done');
}

async function nflschedule(n = 19) {
    console.log('running nfl schedule');
    if (n > 18) {
        // console.log('all done', s);
        const query = { year: 2021 };
        const set = { 'nflschedule.17.games': week18 };
        mongo.update('settings', { query, set });
        return;
    }
    const nfl = await mongo.find('nflteams');
    axios.get(nflurl + n)
        .then(res => {
            const schedule = res.data.nflGames;
            const week = { week: n };
            week.games = _.map(schedule, x => {
                const game = {};
                game._id = x.nflGameId;
                game.week = n;
                game.time = x.gameDateAndTime;
                game.status = x.gameStatus;
                game.quarter = x.gameQuarter;
                game.clock = x.gameClock;
                game.home = {
                    id: (_.find(nfl, t => t.nflTeamId === x.homeTeam.nflTeamId))._id,
                    score: x.homeTeam.score
                }
                game.away = {
                    id: (_.find(nfl, t => t.nflTeamId === x.awayTeam.nflTeamId))._id,
                    score: x.awayTeam.score
                }
                mongo.insertOne('nflschedule', game);
                return game;
            });
            week.byes = _.chain(nfl)
                            .filter(x => x.byeWeek === n)
                            .map(x => x._id)
                            .value();
            // s.push(week);
            nflschedule(++n);
        });
}

// setTimeout(nflschedule, 4000);
// nflschedule();

schedule$
    .subscribe(data => {
        if (data === commands.UPDATEPLAYERS) updatePlayers();
    })